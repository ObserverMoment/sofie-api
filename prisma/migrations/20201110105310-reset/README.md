# Migration `20201110105310-reset`

This migration has been generated by ObserverMoment at 11/10/2020, 10:53:10 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
Begin;
CREATE TYPE "public"."AccessScopeType_new" AS ENUM ('OFFICIAL', 'PUBLIC', 'GROUP', 'PRIVATE');
ALTER TABLE "public"."Workout" ALTER COLUMN "scope" TYPE "AccessScopeType_new" USING ("scope"::text::"AccessScopeType_new");
ALTER TABLE "public"."WorkoutProgram" ALTER COLUMN "scope" TYPE "AccessScopeType_new" USING ("scope"::text::"AccessScopeType_new");
ALTER TYPE "AccessScopeType" RENAME TO "AccessScopeType_old";
ALTER TYPE "AccessScopeType_new" RENAME TO "AccessScopeType";
DROP TYPE "AccessScopeType_old";
Commit

Begin;
CREATE TYPE "public"."MoveType_new" AS ENUM ('STANDARD', 'CUSTOM');
ALTER TABLE "public"."Move" ALTER COLUMN "type" TYPE "MoveType_new" USING ("type"::text::"MoveType_new");
ALTER TYPE "MoveType" RENAME TO "MoveType_old";
ALTER TYPE "MoveType_new" RENAME TO "MoveType";
DROP TYPE "MoveType_old";
Commit

ALTER TABLE "public"."RoundAdjustRule" DROP CONSTRAINT "RoundAdjustRule_workoutSectionId_fkey"

ALTER TABLE "public"."_compoundMoves" DROP CONSTRAINT "_compoundMoves_A_fkey"

ALTER TABLE "public"."_compoundMoves" DROP CONSTRAINT "_compoundMoves_B_fkey"

ALTER TABLE "public"."Equipment" ADD COLUMN "loadAdjustable" boolean   NOT NULL DEFAULT true

ALTER TABLE "public"."GymProfile" ADD COLUMN "bodyweightOnly" boolean   NOT NULL DEFAULT false

ALTER TABLE "public"."LoggedWorkout" DROP COLUMN "difficultyLevel",
DROP COLUMN "originalWorkoutScope",
ADD COLUMN "workoutProgramEnrolmentId" text   

ALTER TABLE "public"."Move" DROP COLUMN "scope",
DROP COLUMN "moveType",
ADD COLUMN "type" "MoveType"  NOT NULL DEFAULT E'STANDARD'

ALTER TABLE "public"."ScheduledWorkout" ALTER COLUMN "workoutId" SET NOT NULL

ALTER TABLE "public"."User" ALTER COLUMN "hasOnboarded" SET NOT NULL,
ALTER COLUMN "themePreference" SET NOT NULL

ALTER TABLE "public"."Workout" ALTER COLUMN "difficultyLevel" SET DEFAULT 50,
ALTER COLUMN "difficultyLevel" SET DATA TYPE integer 

ALTER TABLE "public"."WorkoutType" ADD COLUMN "placeholderImageUrl" text   NOT NULL ,
ALTER COLUMN "description" SET NOT NULL

DROP TYPE "DifficultyLevel"

DROP TYPE "RuleAction"

DROP TYPE "RuleTarget"

CREATE TABLE "public"."MoveProfile" (
"id" text   NOT NULL ,
"userId" text   NOT NULL ,
"name" text   NOT NULL ,
"description" text   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."WorkoutGoal" (
"id" text   NOT NULL ,
"name" text   NOT NULL ,
"description" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."WorkoutProgram" (
"id" text   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"name" text   NOT NULL ,
"description" text   NOT NULL ,
"imageUrl" text   ,
"videoUrl" text   ,
"videoThumbUrl" text   ,
"scope" "AccessScopeType"  NOT NULL DEFAULT E'PRIVATE',
"createdById" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."WorkoutProgramEnrolment" (
"id" text   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"startDate" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,
"workoutProgramId" text   NOT NULL ,
"userId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."WorkoutProgramReview" (
"id" text   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"score" Decimal(65,30)   NOT NULL ,
"comment" text   ,
"workoutProgramId" text   NOT NULL ,
"userId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."WorkoutProgramWorkout" (
"id" text   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"dayNumber" Decimal(65,30)   NOT NULL ,
"notes" text   ,
"workoutProgramId" text   NOT NULL ,
"workoutId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."_EquipmentToGymProfile" (
"A" text   NOT NULL ,
"B" text   NOT NULL 
)

CREATE TABLE "public"."_requiredMoves" (
"A" text   NOT NULL ,
"B" text   NOT NULL 
)

CREATE TABLE "public"."_excludedMoves" (
"A" text   NOT NULL ,
"B" text   NOT NULL 
)

CREATE TABLE "public"."_WorkoutGoalToWorkoutProgram" (
"A" text   NOT NULL ,
"B" text   NOT NULL 
)

DROP TABLE "public"."RoundAdjustRule"

DROP TABLE "public"."_compoundMoves"

CREATE UNIQUE INDEX "_EquipmentToGymProfile_AB_unique" ON "public"."_EquipmentToGymProfile"("A", "B")

CREATE INDEX "_EquipmentToGymProfile_B_index" ON "public"."_EquipmentToGymProfile"("B")

CREATE UNIQUE INDEX "_requiredMoves_AB_unique" ON "public"."_requiredMoves"("A", "B")

CREATE INDEX "_requiredMoves_B_index" ON "public"."_requiredMoves"("B")

CREATE UNIQUE INDEX "_excludedMoves_AB_unique" ON "public"."_excludedMoves"("A", "B")

CREATE INDEX "_excludedMoves_B_index" ON "public"."_excludedMoves"("B")

CREATE UNIQUE INDEX "_WorkoutGoalToWorkoutProgram_AB_unique" ON "public"."_WorkoutGoalToWorkoutProgram"("A", "B")

CREATE INDEX "_WorkoutGoalToWorkoutProgram_B_index" ON "public"."_WorkoutGoalToWorkoutProgram"("B")

ALTER TABLE "public"."MoveProfile" ADD FOREIGN KEY("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."WorkoutProgram" ADD FOREIGN KEY("createdById")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."WorkoutProgramEnrolment" ADD FOREIGN KEY("workoutProgramId")REFERENCES "public"."WorkoutProgram"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."WorkoutProgramEnrolment" ADD FOREIGN KEY("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."WorkoutProgramReview" ADD FOREIGN KEY("workoutProgramId")REFERENCES "public"."WorkoutProgram"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."WorkoutProgramReview" ADD FOREIGN KEY("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."WorkoutProgramWorkout" ADD FOREIGN KEY("workoutProgramId")REFERENCES "public"."WorkoutProgram"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."WorkoutProgramWorkout" ADD FOREIGN KEY("workoutId")REFERENCES "public"."Workout"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_EquipmentToGymProfile" ADD FOREIGN KEY("A")REFERENCES "public"."Equipment"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_EquipmentToGymProfile" ADD FOREIGN KEY("B")REFERENCES "public"."GymProfile"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_requiredMoves" ADD FOREIGN KEY("A")REFERENCES "public"."Move"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_requiredMoves" ADD FOREIGN KEY("B")REFERENCES "public"."MoveProfile"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_excludedMoves" ADD FOREIGN KEY("A")REFERENCES "public"."Move"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_excludedMoves" ADD FOREIGN KEY("B")REFERENCES "public"."MoveProfile"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_WorkoutGoalToWorkoutProgram" ADD FOREIGN KEY("A")REFERENCES "public"."WorkoutGoal"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_WorkoutGoalToWorkoutProgram" ADD FOREIGN KEY("B")REFERENCES "public"."WorkoutProgram"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."LoggedWorkout" ADD FOREIGN KEY("workoutProgramEnrolmentId")REFERENCES "public"."WorkoutProgramEnrolment"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20201110105310-reset
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,396 @@
+// https://github.com/prisma/prisma2
+// SDL first example: https://github.com/prisma/prisma-examples/tree/prisma2/javascript/graphql-sdl-first
+// Migrations: https://github.com/prisma/migrate
+generator client {
+  provider = "prisma-client-js"
+}
+
+datasource db {
+  provider = "postgresql"
+  url = "***"
+}
+
+model Equipment {
+  id                 String        @id @default(uuid())
+  name               String        @unique
+  imageUrl           String?
+  loadAdjustable     Boolean       @default(true)
+  requiredForMoves   Move[]        @relation("moveToRequiredEquipments", references: [id])
+  selectableForMoves Move[]        @relation("moveToSelectableEquipments", references: [id])
+  workoutMoves       WorkoutMove[]
+  gymProfiles        GymProfile[]
+}
+
+model GymProfile {
+  id                  String             @id @default(uuid())
+  user                User               @relation(fields: [userId], references: [id])
+  userId              String
+  name                String
+  description         String?
+  postcode            String?
+  // i.e. there is no equipment as this gym.
+  bodyweightOnly      Boolean            @default(false)
+  availableEquipments Equipment[]
+  scheduledWorkouts   ScheduledWorkout[]
+  loggedWorkouts      LoggedWorkout[]
+}
+
+model LikedWorkout {
+  createdAt DateTime @default(now())
+  user      User     @relation(fields: [userId], references: [id])
+  userId    String
+  notes     String?
+  workout   Workout  @relation(fields: [workoutId], references: [id])
+  workoutId String
+
+  @@id([userId, workoutId])
+}
+
+// Data from a completed workout. Also inlcudes relation to the 'original' workout
+model LoggedWorkout {
+  id                        String                   @id @default(uuid())
+  name                      String
+  summary                   String?
+  description               String?
+  createdAt                 DateTime                 @default(now())
+  completedOn               DateTime
+  completedBy               User                     @relation(fields: [completedById], references: [id])
+  completedById             String
+  notes                     String?
+  videoUrl                  String?
+  videoThumbUrl             String?
+  imageUrl                  String?
+  duration                  Int?
+  workoutType               WorkoutType              @relation(fields: [workoutTypeId], references: [id])
+  workoutTypeId             String
+  /// @onDelete(CASCADE)
+  workoutSections           WorkoutSection[]
+  originalWorkout           Workout?                 @relation(fields: [originalWorkoutId], references: [id])
+  originalWorkoutId         String?
+  scheduledWorkout          ScheduledWorkout?
+  scheduledWorkoutId        String?
+  gymProfile                GymProfile?              @relation(fields: [gymProfileId], references: [id])
+  gymProfileId              String?
+  // Logged workouts against a particular user and program in which they are enrolled.
+  // Enables tracking of completeness of the program and also history / score generation.
+  workoutProgramEnrolment   WorkoutProgramEnrolment? @relation(fields: [workoutProgramEnrolmentId], references: [id])
+  workoutProgramEnrolmentId String?
+}
+
+model Move {
+  id                   String               @id @default(uuid())
+  createdAt            DateTime             @default(now())
+  createdBy            User?                @relation(fields: [createdById], references: [id])
+  createdById          String?
+  type                 MoveType             @default(STANDARD)
+  name                 String               @unique
+  description          String?
+  demoVideoUrl         String?
+  validRepTypes        WorkoutMoveRepType[]
+  requiredEquipments   Equipment[]          @relation("moveToRequiredEquipments", references: [id])
+  selectableEquipments Equipment[]          @relation("moveToSelectableEquipments", references: [id])
+  moveProfileRequired  MoveProfile[]        @relation("requiredMoves", references: [id])
+  moveProfileExcluded  MoveProfile[]        @relation("excludedMoves", references: [id])
+  workoutMoves         WorkoutMove[]
+}
+
+model MoveProfile {
+  id            String  @id @default(uuid())
+  user          User    @relation(fields: [userId], references: [id])
+  userId        String
+  name          String
+  description   String?
+  requiredMoves Move[]  @relation("requiredMoves", references: [id])
+  excludedMoves Move[]  @relation("excludedMoves", references: [id])
+}
+
+model ScheduledWorkout {
+  id              String         @id @default(uuid())
+  createdAt       DateTime       @default(now())
+  user            User           @relation(fields: [userId], references: [id])
+  userId          String
+  notes           String?
+  scheduledAt     DateTime       @default(now())
+  workout         Workout        @relation(fields: [workoutId], references: [id])
+  workoutId       String
+  loggedWorkout   LoggedWorkout? @relation(fields: [loggedWorkoutId], references: [id])
+  loggedWorkoutId String?
+  gymProfile      GymProfile?    @relation(fields: [gymProfileId], references: [id])
+  gymProfileId    String?
+}
+
+// Height in cms / weight in kgs
+model User {
+  id                       String                    @id @default(uuid())
+  firebaseUid              String                    @unique
+  createdAt                DateTime                  @default(now())
+  hasOnboarded             Boolean                   @default(false)
+  avatarUrl                String?
+  displayName              String?                   @unique
+  firstname                String?
+  lastname                 String?
+  themePreference          ThemePreference           @default(DARK)
+  bio                      String?
+  birthdate                DateTime?
+  gender                   Gender?                   @default(UNSPECIFIED)
+  height                   Float?
+  weight                   Float?
+  townCity                 String?
+  countryCode              String?
+  unitSystem               UnitSystem                @default(METRIC)
+  followedBy               User[]                    @relation("UserFollows", references: [id])
+  following                User[]                    @relation("UserFollows", references: [id])
+  moves                    Move[]
+  workouts                 Workout[]
+  /// @onDelete(CASCADE)
+  scheduledWorkouts        ScheduledWorkout[]
+  /// @onDelete(CASCADE)
+  loggedWorkouts           LoggedWorkout[]
+  /// @onDelete(CASCADE)
+  likedWorkouts            LikedWorkout[]
+  /// @onDelete(CASCADE)
+  gymProfiles              GymProfile[]
+  /// @onDelete(CASCADE)
+  moveProfiles             MoveProfile[]
+  workoutProgramsCreated   WorkoutProgram[]
+  /// @onDelete(CASCADE)
+  workoutProgramEnrolments WorkoutProgramEnrolment[]
+  workoutProgramReviews    WorkoutProgramReview[]
+}
+
+model Workout {
+  id                String                  @id @default(uuid())
+  createdAt         DateTime                @default(now())
+  createdBy         User?                   @relation(fields: [createdById], references: [id])
+  createdById       String?
+  name              String
+  summary           String?
+  description       String?
+  demoVideoUrl      String?
+  demoVideoThumbUrl String?
+  youtubeVideoUrl   String?
+  spotifyAudio      String?
+  imageUrl          String?
+  timecap           Int?
+  // structureData holds config info for certain workout types. E.g. Circuits and Tabatas.
+  builderData       Json?
+  difficultyLevel   Int                     @default(50)
+  scope             AccessScopeType         @default(PRIVATE)
+  workoutType       WorkoutType             @relation(fields: [workoutTypeId], references: [id])
+  workoutTypeId     String
+  /// @onDelete(CASCADE)
+  workoutSections   WorkoutSection[]
+  scheduledWorkouts ScheduledWorkout[]
+  workoutLogs       LoggedWorkout[]
+  /// @onDelete(CASCADE)
+  likes             LikedWorkout[]
+  workoutPrograms   WorkoutProgramWorkout[]
+}
+
+model WorkoutGoal {
+  id              String           @id @default(uuid())
+  name            String
+  description     String
+  workoutPrograms WorkoutProgram[]
+}
+
+model WorkoutMove {
+  id                  String             @id @default(uuid())
+  createdAt           DateTime           @default(now())
+  sortPosition        Int
+  repType             WorkoutMoveRepType @default(REPS)
+  reps                Float?             @default(10)
+  distanceUnit        DistanceUnit       @default(METRES)
+  loadAmount          Float?
+  loadUnit            LoadUnit           @default(KG)
+  // For logging. Number of seconds it took to complete the workoutMove
+  duration            Int?
+  description         String?
+  notes               String?
+  move                Move               @relation(fields: [moveId], references: [id])
+  moveId              String
+  selectedEquipment   Equipment?         @relation(fields: [selectedEquipmentId], references: [id])
+  selectedEquipmentId String?
+  workoutSection      WorkoutSection     @relation(fields: [workoutSectionId], references: [id])
+  workoutSectionId    String
+}
+
+model WorkoutProgram {
+  id              String                    @id @default(uuid())
+  createdAt       DateTime                  @default(now())
+  name            String
+  description     String
+  imageUrl        String?
+  videoUrl        String?
+  videoThumbUrl   String?
+  scope           AccessScopeType           @default(PRIVATE)
+  createdBy       User                      @relation(fields: [createdById], references: [id])
+  createdById     String
+  /// @onDelete(CASCADE)
+  enrolments      WorkoutProgramEnrolment[]
+  workoutGoals    WorkoutGoal[]
+  /// @onDelete(CASCADE)
+  programWorkouts WorkoutProgramWorkout[]
+  /// @onDelete(CASCADE)
+  programReviews  WorkoutProgramReview[]
+}
+
+model WorkoutProgramEnrolment {
+  id               String          @id @default(uuid())
+  createdAt        DateTime        @default(now())
+  startDate        DateTime?       @default(now())
+  workoutProgram   WorkoutProgram  @relation(fields: [workoutProgramId], references: [id])
+  workoutProgramId String
+  user             User            @relation(fields: [userId], references: [id])
+  userId           String
+  loggedWorkouts   LoggedWorkout[]
+}
+
+model WorkoutProgramReview {
+  id               String         @id @default(uuid())
+  createdAt        DateTime       @default(now())
+  score            Float
+  comment          String?
+  workoutProgram   WorkoutProgram @relation(fields: [workoutProgramId], references: [id])
+  workoutProgramId String
+  user             User           @relation(fields: [userId], references: [id])
+  userId           String
+}
+
+model WorkoutProgramWorkout {
+  id               String         @id @default(uuid())
+  createdAt        DateTime       @default(now())
+  // Day on which the workout is planned. i.e. day 8 == week 2 day 1.
+  // The decimal can be used to differentiate between having multiple workouts on each day.
+  dayNumber        Float
+  notes            String?
+  workoutProgram   WorkoutProgram @relation(fields: [workoutProgramId], references: [id])
+  workoutProgramId String
+  workout          Workout        @relation(fields: [workoutId], references: [id])
+  workoutId        String
+}
+
+// Need to implement some more solid polymorphism here if we want to allow a workoutSection
+// to be on a workout or a loggedWorkout
+// Currently no validation makinhg sure the section is not parentless.
+model WorkoutSection {
+  id              String         @id @default(uuid())
+  createdAt       DateTime       @default(now())
+  sortPosition    Int
+  notes           String?
+  timecap         Int?
+  // For logging. Number of seconds it took to complete a single round of the section
+  duration        Int?
+  rounds          Int
+  workout         Workout?       @relation(fields: [workoutId], references: [id])
+  workoutId       String?
+  /// @onDelete(CASCADE)
+  workoutMoves    WorkoutMove[]
+  /// @onDelete(CASCADE)
+  // roundAdjustRules RoundAdjustRule[]
+  loggedWorkout   LoggedWorkout? @relation(fields: [loggedWorkoutId], references: [id])
+  loggedWorkoutId String?
+}
+
+model WorkoutType {
+  id                  String           @id @default(uuid())
+  name                String
+  description         String
+  placeholderImageUrl String
+  scoreType           WorkoutScoreType
+  workouts            Workout[]
+  loggedWorkouts      LoggedWorkout[]
+}
+
+// Enums
+enum AccessScopeType {
+  OFFICIAL
+  PUBLIC
+  GROUP
+  PRIVATE
+}
+
+enum DistanceUnit {
+  METRES
+  KILOMETRES
+  YARDS
+  MILES
+}
+
+enum FrequencyPeriod {
+  DAY
+  TWODAYS
+  WEEK
+  TWOWEEKS
+  MONTH
+}
+
+enum Gender {
+  MALE
+  FEMALE
+  UNSPECIFIED
+}
+
+enum LoadUnit {
+  KG
+  LB
+  BODYWEIGHTPERCENT
+}
+
+// Standard moves are built in / official.
+// Custom moves are created by users.
+enum MoveType {
+  STANDARD
+  CUSTOM
+}
+
+enum ThemePreference {
+  DARK
+  LIGHT
+}
+
+enum UnitSystem {
+  IMPERIAL
+  METRIC
+}
+
+enum WorkoutMoveRepType {
+  REPS
+  CALORIES
+  DISTANCE
+  TIME
+}
+
+// AMREPS in reps
+// TIME in seconds
+// LOAD in kgs
+enum WorkoutScoreType {
+  AMREPS
+  FORTIME
+  FORLOAD
+}
+
+//// Not being used ///
+// Every {roundFrequency} rounds {operator} reps by {amount}
+// Eg. Every 3 rounds INCREASE reps by 10 (for all workout moves within the section)
+// Currently not in use pending validation of concept and design of UI.
+// model RoundAdjustRule {
+//   id               String         @id @default(uuid())
+//   action           RuleAction
+//   target           RuleTarget
+//   amount           Float
+//   roundFrequency   Int            @default(1) // Every round
+//   WorkoutSection   WorkoutSection @relation(fields: [workoutSectionId], references: [id])
+//   workoutSectionId String
+// }
+
+// enum RuleAction {
+//   INCREASE
+//   DECREASE
+//   MULTIPLY
+// }
+
+// enum RuleTarget {
+//   REPS
+//   LOAD
+// }
```



# Migration `20200807145716-logged-workout`

This migration has been generated by ObserverMoment at 8/7/2020, 2:57:16 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
DROP INDEX "public"."ScheduledWorkout_workoutScoreId"

DROP INDEX "public"."ScoreSubmission_workoutScoreId"

ALTER TABLE "public"."ScheduledWorkout" DROP CONSTRAINT "ScheduledWorkout_workoutScoreId_fkey"

ALTER TABLE "public"."ScoreSubmission" DROP CONSTRAINT "ScoreSubmission_workoutScoreId_fkey"

CREATE TABLE "public"."LoggedWorkout" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"completedOn" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"completedById" text  NOT NULL ,
"notes" text   ,
"workoutId" text  NOT NULL ,
"scheduledWorkoutId" text   ,
PRIMARY KEY ("id"))

ALTER TABLE "public"."RoundAdjustRule" ALTER COLUMN "target" DROP DEFAULT;

ALTER TABLE "public"."ScheduledWorkout" DROP COLUMN "workoutScoreId",
ADD COLUMN "loggedWorkoutId" text   ;

ALTER TABLE "public"."ScoreSubmission" DROP COLUMN "workoutScoreId",
ADD COLUMN "loggedWorkoutId" text  NOT NULL ;

ALTER TABLE "public"."WorkoutSection" DROP COLUMN "repPyramid",
DROP COLUMN "repPyramidStructure",
DROP COLUMN "weightPyramid",
DROP COLUMN "weightPyramidStructure",
ADD COLUMN "loggedWorkoutId" text   ;

CREATE UNIQUE INDEX "ScheduledWorkout_loggedWorkoutId" ON "public"."ScheduledWorkout"("loggedWorkoutId")

ALTER TABLE "public"."LoggedWorkout" ADD FOREIGN KEY ("completedById")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."LoggedWorkout" ADD FOREIGN KEY ("workoutId")REFERENCES "public"."Workout"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."ScheduledWorkout" ADD FOREIGN KEY ("loggedWorkoutId")REFERENCES "public"."LoggedWorkout"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."ScoreSubmission" ADD FOREIGN KEY ("loggedWorkoutId")REFERENCES "public"."LoggedWorkout"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."WorkoutSection" ADD FOREIGN KEY ("loggedWorkoutId")REFERENCES "public"."LoggedWorkout"("id") ON DELETE SET NULL ON UPDATE CASCADE

DROP TABLE "public"."WorkoutScore";
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200729214730-rep-reps..20200807145716-logged-workout
--- datamodel.dml
+++ datamodel.dml
@@ -6,9 +6,9 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 model ScoreSubmission {
   id                     String                @default(uuid()) @id
@@ -20,10 +20,10 @@
   challenge              Challenge?            @relation(fields: [challengeId], references: [id])
   challengeId            String?
   scoreSubmissionVideo   ScoreSubmissionVideo? @relation(fields: [scoreSubmissionVideoId], references: [id])
   scoreSubmissionVideoId String?
-  workoutScore           WorkoutScore          @relation(fields: [workoutScoreId], references: [id])
-  workoutScoreId         String
+  loggedWorkout          LoggedWorkout         @relation(fields: [loggedWorkoutId], references: [id])
+  loggedWorkoutId        String
 }
 model ScoreSubmissionVideo {
   id                              String                           @default(uuid()) @id
@@ -132,41 +132,53 @@
   selectableEquipments Equipment[]          @relation("moveToSelectableEquipments", references: [id])
   workoutMoves         WorkoutMove[]
 }
-model WorkoutMove {
-  id                  String             @default(uuid()) @id
-  createdAt           DateTime           @default(now())
-  sortPosition        Int
-  repType             WorkoutMoveRepType @default(REPS)
-  reps                Float?             @default(10)
-  distanceUnit        DistanceUnit       @default(METRES)
-  loadAmount          Float?
-  loadUnit            LoadUnit           @default(KG)
-  description         String?
-  move                Move               @relation(fields: [moveId], references: [id])
-  moveId              String
-  selectedEquipment   Equipment?         @relation(fields: [selectedEquipmentId], references: [id])
-  selectedEquipmentId String?
-  workoutSection      WorkoutSection     @relation(fields: [workoutSectionId], references: [id])
-  workoutSectionId    String
+model WorkoutType {
+  id          String           @default(uuid()) @id
+  name        String
+  description String?
+  scoreType   WorkoutScoreType
+  Workout     Workout[]
 }
+model Workout {
+  id                String             @default(uuid()) @id
+  createdAt         DateTime           @default(now())
+  createdBy         User?              @relation(fields: [createdById], references: [id])
+  createdById       String?
+  name              String
+  summary           String?
+  description       String?
+  demoVideoUrl      String?
+  demoVideoThumbUrl String?
+  youtubeVideoUrl   String?
+  spotifyAudio      String?
+  imageUrl          String?
+  timecap           Int?
+  difficultyLevel   DifficultyLevel    @default(ONE)
+  scope             AccessScopeType    @default(PRIVATE)
+  workoutType       WorkoutType        @relation(fields: [workoutTypeId], references: [id])
+  workoutTypeId     String
+  challenges        Challenge[]        @relation(references: [id])
+  scheduledWorkouts ScheduledWorkout[]
+  workoutSections   WorkoutSection[]
+  LoggedWorkout     LoggedWorkout[]
+}
+
 model WorkoutSection {
-  id                     String            @default(uuid()) @id
-  createdAt              DateTime          @default(now())
-  sortPosition           Int
-  notes                  String?
-  repPyramid             Boolean           @default(false)
-  repPyramidStructure    Int[]
-  weightPyramid          Boolean           @default(false)
-  weightPyramidStructure Int[]
-  timecap                Int?
-  rounds                 Int               @default(1)
-  workout                Workout           @relation(fields: [workoutId], references: [id])
-  workoutId              String
-  workoutMoves           WorkoutMove[]
-  roundAdjustRules       RoundAdjustRule[]
+  id               String            @default(uuid()) @id
+  createdAt        DateTime          @default(now())
+  sortPosition     Int
+  notes            String?
+  timecap          Int?
+  rounds           Int               @default(1)
+  workout          Workout           @relation(fields: [workoutId], references: [id])
+  workoutId        String
+  workoutMoves     WorkoutMove[]
+  roundAdjustRules RoundAdjustRule[]
+  LoggedWorkout    LoggedWorkout?    @relation(fields: [loggedWorkoutId], references: [id])
+  loggedWorkoutId  String?
 }
 // Every {roundFrequency} rounds {operator} reps by {amount}
 // Eg. Every 3 rounds INCREASE reps by 10 (for all workout moves within the section)
@@ -190,65 +202,56 @@
   REPS
   LOAD
 }
-model Workout {
-  id                String             @default(uuid()) @id
-  createdAt         DateTime           @default(now())
-  createdBy         User?              @relation(fields: [createdById], references: [id])
-  createdById       String?
-  name              String
-  summary           String?
-  description       String?
-  demoVideoUrl      String?
-  demoVideoThumbUrl String?
-  youtubeVideoUrl   String?
-  spotifyAudio      String?
-  imageUrl          String?
-  timecap           Int?
-  difficultyLevel   DifficultyLevel    @default(ONE)
-  scope             AccessScopeType    @default(PRIVATE)
-  workoutType       WorkoutType        @relation(fields: [workoutTypeId], references: [id])
-  workoutTypeId     String
-  challenges        Challenge[]        @relation(references: [id])
-  scheduledWorkouts ScheduledWorkout[]
-  workoutSections   WorkoutSection[]
+model WorkoutMove {
+  id                  String             @default(uuid()) @id
+  createdAt           DateTime           @default(now())
+  sortPosition        Int
+  repType             WorkoutMoveRepType @default(REPS)
+  reps                Float?             @default(10)
+  distanceUnit        DistanceUnit       @default(METRES)
+  loadAmount          Float?
+  loadUnit            LoadUnit           @default(KG)
+  description         String?
+  move                Move               @relation(fields: [moveId], references: [id])
+  moveId              String
+  selectedEquipment   Equipment?         @relation(fields: [selectedEquipmentId], references: [id])
+  selectedEquipmentId String?
+  workoutSection      WorkoutSection     @relation(fields: [workoutSectionId], references: [id])
+  workoutSectionId    String
 }
-model WorkoutType {
-  id          String           @default(uuid()) @id
-  name        String
-  description String?
-  scoreType   WorkoutScoreType
-  Workout     Workout[]
-}
-
 model ScheduledWorkout {
-  id             String       @default(uuid()) @id
-  createdAt      DateTime     @default(now())
-  createdBy      User         @relation(fields: [createdById], references: [id])
-  createdById    String
-  notes          String?
-  scheduledAt    DateTime     @default(now())
-  completed      Boolean      @default(false)
-  workout        Workout      @relation(fields: [workoutId], references: [id])
-  workoutId      String
-  workoutScore   WorkoutScore @relation(fields: [workoutScoreId], references: [id])
-  workoutScoreId String
-  challenge      Challenge?   @relation(fields: [challengeId], references: [id])
-  challengeId    String?
+  id              String         @default(uuid()) @id
+  createdAt       DateTime       @default(now())
+  createdBy       User           @relation(fields: [createdById], references: [id])
+  createdById     String
+  notes           String?
+  scheduledAt     DateTime       @default(now())
+  completed       Boolean        @default(false)
+  workout         Workout        @relation(fields: [workoutId], references: [id])
+  workoutId       String
+  loggedWorkout   LoggedWorkout? @relation(fields: [loggedWorkoutId], references: [id])
+  loggedWorkoutId String?
+  challenge       Challenge?     @relation(fields: [challengeId], references: [id])
+  challengeId     String?
 }
-// log is for data from the workout itself (i.e. time per round) - auto generated by the app
-// notes is optional user input
-model WorkoutScore {
-  id               String           @default(uuid()) @id
-  createdAt        DateTime         @default(now())
-  score            Int
-  log              String?
-  notes            String?
-  scheduledWorkout ScheduledWorkout
-  scoreSubmission  ScoreSubmission?
+// Data from a completed workout.
+model LoggedWorkout {
+  id                 String            @default(uuid()) @id
+  createdAt          DateTime          @default(now())
+  completedOn        DateTime          @default(now())
+  completedBy        User              @relation(fields: [completedById], references: [id])
+  completedById      String
+  notes              String?
+  workoutSections    WorkoutSection[]
+  workout            Workout           @relation(fields: [workoutId], references: [id])
+  workoutId          String
+  scheduledWorkout   ScheduledWorkout?
+  scheduledWorkoutId String?
+  scoreSubmissions   ScoreSubmission[]
 }
 // Height in cms / weight in kgs
 model User {
@@ -284,8 +287,9 @@
   groupsWhereCreator                 Group[]                              @relation("groupToCreator")
   moves                              Move[]
   workouts                           Workout[]
   scheduledWorkouts                  ScheduledWorkout[]
+  loggedWorkouts                     LoggedWorkout[]
 }
 // Enums
 enum AccessScopeType {
```



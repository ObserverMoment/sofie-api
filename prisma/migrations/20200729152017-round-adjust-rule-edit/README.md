# Migration `20200729152017-round-adjust-rule-edit`

This migration has been generated by ObserverMoment at 7/29/2020, 3:20:17 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "RuleSubject" AS ENUM ('REP', 'LOAD');

ALTER TABLE "public"."WorkoutSection" DROP CONSTRAINT "WorkoutSection_loadAdjustRuleId_fkey"

ALTER TABLE "public"."WorkoutSection" DROP CONSTRAINT "WorkoutSection_repAdjustRuleId_fkey"

ALTER TABLE "public"."RoundAdjustRule" ADD COLUMN "subject" "RuleOperator" NOT NULL ,
ADD COLUMN "workoutSectionId" text   ,
DROP COLUMN "operator",
ADD COLUMN "operator" "RuleSubject" NOT NULL ;

ALTER TABLE "public"."WorkoutSection" DROP COLUMN "repAdjustRuleId",
DROP COLUMN "loadAdjustRuleId";

ALTER TABLE "public"."RoundAdjustRule" ADD FOREIGN KEY ("workoutSectionId")REFERENCES "public"."WorkoutSection"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200729150710-round-adjust-rule..20200729152017-round-adjust-rule-edit
--- datamodel.dml
+++ datamodel.dml
@@ -6,9 +6,9 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 model ScoreSubmission {
   id                     String                @default(uuid()) @id
@@ -151,45 +151,48 @@
   workoutSectionId    String
 }
 model WorkoutSection {
-  id                     String           @default(uuid()) @id
-  createdAt              DateTime         @default(now())
+  id                     String            @default(uuid()) @id
+  createdAt              DateTime          @default(now())
   sortPosition           Int
   notes                  String?
-  repPyramid             Boolean          @default(false)
+  repPyramid             Boolean           @default(false)
   repPyramidStructure    Int[]
-  weightPyramid          Boolean          @default(false)
+  weightPyramid          Boolean           @default(false)
   weightPyramidStructure Int[]
   timecap                Int?
-  rounds                 Int              @default(1)
-  repAdjustRule          RoundAdjustRule? @relation("repAdjustRule", fields: [repAdjustRuleId], references: [id])
-  repAdjustRuleId        String?
-  loadAdjustRule         RoundAdjustRule? @relation("loadAdjustRule", fields: [loadAdjustRuleId], references: [id])
-  loadAdjustRuleId       String?
-  workout                Workout          @relation(fields: [workoutId], references: [id])
+  rounds                 Int               @default(1)
+  workout                Workout           @relation(fields: [workoutId], references: [id])
   workoutId              String
   workoutMoves           WorkoutMove[]
+  roundAdjustRules       RoundAdjustRule[]
 }
 // Every {roundFrequency} rounds {operator} reps by {amount}
 // Eg. Every 3 rounds INCREASE reps by 10 (for all workout moves within the section)
 model RoundAdjustRule {
-  id             String           @default(uuid()) @id
-  name           String
-  description    String?
-  operator       RuleOperator
-  amount         Int
-  roundFrequency Int              @default(1) // Every round
-  repAdjusted    WorkoutSection[] @relation("repAdjustRule")
-  loadAdjusted   WorkoutSection[] @relation("loadAdjustRule")
+  id               String          @default(uuid()) @id
+  name             String
+  description      String?
+  subject          RuleOperator
+  operator         RuleSubject
+  amount           Int
+  roundFrequency   Int             @default(1) // Every round
+  WorkoutSection   WorkoutSection? @relation(fields: [workoutSectionId], references: [id])
+  workoutSectionId String?
 }
 enum RuleOperator {
   INCREASE
   DECREASE
 }
+enum RuleSubject {
+  REP
+  LOAD
+}
+
 model Workout {
   id                String             @default(uuid()) @id
   createdAt         DateTime           @default(now())
   createdBy         User?              @relation(fields: [createdById], references: [id])
```



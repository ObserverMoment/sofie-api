# Migration `20201230153639-progress-journal-and-user-benchmark`

This migration has been generated by ObserverMoment at 12/30/2020, 3:36:39 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."BenchmarkScoreType" AS ENUM ('LOAD', 'REPS', 'TIME')

DROP INDEX "Move.name_unique"

ALTER TABLE "WorkoutType" ALTER COLUMN "subtitle" SET NOT NULL

CREATE TABLE "ProgressJournal" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "userId" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,

    PRIMARY KEY ("id")
)

CREATE TABLE "ProgressJournalEntry" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "notes" TEXT,
    "bodyWeight" DECIMAL(65,30),
    "moodScore" DECIMAL(65,30),
    "energyScore" DECIMAL(65,30),
    "healthScore" DECIMAL(65,30),
    "fitnessScore" DECIMAL(65,30),
    "sleepScore" DECIMAL(65,30),
    "socialScore" DECIMAL(65,30),
    "progressJournalId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "ProgressJournalEntryPhoto" (
    "id" TEXT NOT NULL,
    "dateTaken" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "notes" TEXT,
    "progressJournalEntryId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "ProgressJournalGoal" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "completedDate" TIMESTAMP(3),
    "progressJournalId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "UserBenchmark" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "createdById" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "reps" DECIMAL(65,30) NOT NULL,
    "repType" "WorkoutMoveRepType" NOT NULL DEFAULT E'REPS',
    "load" DECIMAL(65,30),
    "loadUnit" "LoadUnit" NOT NULL DEFAULT E'KG',
    "distanceUnit" "DistanceUnit" NOT NULL DEFAULT E'METRES',
    "scoreType" "BenchmarkScoreType" NOT NULL DEFAULT E'LOAD',
    "moveId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "UserBenchmarkEntry" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "score" DECIMAL(65,30) NOT NULL,
    "notes" TEXT,
    "videoUrl" TEXT,
    "imageUrl" TEXT,
    "userBenchmarkId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "_EquipmentToUserBenchmark" (
    "A" TEXT NOT NULL,
    "B" TEXT NOT NULL
)

CREATE UNIQUE INDEX "_EquipmentToUserBenchmark_AB_unique" ON "_EquipmentToUserBenchmark"("A", "B")

CREATE INDEX "_EquipmentToUserBenchmark_B_index" ON "_EquipmentToUserBenchmark"("B")

ALTER TABLE "ProgressJournal" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "ProgressJournalEntry" ADD FOREIGN KEY("progressJournalId")REFERENCES "ProgressJournal"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "ProgressJournalEntryPhoto" ADD FOREIGN KEY("progressJournalEntryId")REFERENCES "ProgressJournalEntry"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "ProgressJournalGoal" ADD FOREIGN KEY("progressJournalId")REFERENCES "ProgressJournal"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "UserBenchmark" ADD FOREIGN KEY("createdById")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "UserBenchmark" ADD FOREIGN KEY("moveId")REFERENCES "Move"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "UserBenchmarkEntry" ADD FOREIGN KEY("userBenchmarkId")REFERENCES "UserBenchmark"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_EquipmentToUserBenchmark" ADD FOREIGN KEY("A")REFERENCES "Equipment"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_EquipmentToUserBenchmark" ADD FOREIGN KEY("B")REFERENCES "UserBenchmark"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201221092209-workout-type-subtitle-2..20201230153639-progress-journal-and-user-benchmark
--- datamodel.dml
+++ datamodel.dml
@@ -6,9 +6,9 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 model BodyArea {
   id                 String              @id @default(uuid())
@@ -31,18 +31,19 @@
   @@id([moveId, bodyAreaId])
 }
 model Equipment {
-  id                 String        @id @default(uuid())
-  createdAt          DateTime      @default(now())
-  name               String        @unique
+  id                 String          @id @default(uuid())
+  createdAt          DateTime        @default(now())
+  name               String          @unique
   altNames           String?
   imageUrl           String?
-  loadAdjustable     Boolean       @default(true)
-  requiredForMoves   Move[]        @relation("moveToRequiredEquipments", references: [id])
-  selectableForMoves Move[]        @relation("moveToSelectableEquipments", references: [id])
+  loadAdjustable     Boolean         @default(true)
+  requiredForMoves   Move[]          @relation("moveToRequiredEquipments", references: [id])
+  selectableForMoves Move[]          @relation("moveToSelectableEquipments", references: [id])
   workoutMoves       WorkoutMove[]
   gymProfiles        GymProfile[]
+  userBenchmarks     UserBenchmark[]
 }
 model GymProfile {
   id                  String             @id @default(uuid())
@@ -118,13 +119,13 @@
   createdAt               DateTime             @default(now())
   createdBy               User?                @relation(fields: [createdById], references: [id])
   createdById             String?
   // Default to CUSTOM. GQL Schema does not accept this field as an input.
-  // A creator should never be able to create a STANDARD move (aka an official move)
+  // A user should never be able to create a STANDARD move (aka an official move)
   scope                   MoveScope            @default(CUSTOM)
   type                    MoveType             @default(GENERAL)
-  // Should be very short!
-  name                    String               @unique
+  // Should be short!
+  name                    String
   // Text search will search this field - include the main name + any common variations
   // E.g. Air Bike, Assault Bike, specific brands, common misspellings etc.
   searchTerms             String?
   description             String?
@@ -137,8 +138,10 @@
   excludedForMoveProfiles MoveProfile[]        @relation("excludedMoves", references: [id])
   workoutMoves            WorkoutMove[]
   /// @onDelete(CASCADE)
   bodyAreaMoveScores      BodyAreaMoveScore[]
+  /// @onDelete(CASCADE)
+  userBenchmarks          UserBenchmark[]
 }
 model MoveProfile {
   id            String   @id @default(uuid())
@@ -150,8 +153,53 @@
   requiredMoves Move[]   @relation("requiredMoves", references: [id])
   excludedMoves Move[]   @relation("excludedMoves", references: [id])
 }
+model ProgressJournal {
+  id                     String                 @id @default(uuid())
+  createdAt              DateTime               @default(now())
+  user                   User                   @relation(fields: [userId], references: [id])
+  userId                 String
+  name                   String
+  description            String?
+  progressJournalEntries ProgressJournalEntry[]
+  progressJournalGoals   ProgressJournalGoal[]
+}
+
+model ProgressJournalEntry {
+  id                String                      @id @default(uuid())
+  createdAt         DateTime                    @default(now())
+  notes             String?
+  bodyWeight        Float?
+  moodScore         Float?
+  energyScore       Float?
+  healthScore       Float?
+  fitnessScore      Float?
+  sleepScore        Float?
+  socialScore       Float?
+  progressPhotos    ProgressJournalEntryPhoto[]
+  progressJournal   ProgressJournal             @relation(fields: [progressJournalId], references: [id])
+  progressJournalId String
+}
+
+model ProgressJournalEntryPhoto {
+  id                     String               @id @default(uuid())
+  dateTaken              DateTime             @default(now())
+  notes                  String?
+  progressJournalEntry   ProgressJournalEntry @relation(fields: [progressJournalEntryId], references: [id])
+  progressJournalEntryId String
+}
+
+model ProgressJournalGoal {
+  id                String          @id @default(uuid())
+  createdAt         DateTime        @default(now())
+  name              String
+  description       String?
+  completedDate     DateTime?
+  progressJournal   ProgressJournal @relation(fields: [progressJournalId], references: [id])
+  progressJournalId String
+}
+
 model ScheduledWorkout {
   id              String         @id @default(uuid())
   createdAt       DateTime       @default(now())
   user            User           @relation(fields: [userId], references: [id])
@@ -211,11 +259,46 @@
   workoutPrograms          WorkoutProgram[]
   /// @onDelete(CASCADE)
   workoutProgramEnrolments WorkoutProgramEnrolment[]
   workoutProgramReviews    WorkoutProgramReview[]
+  /// @onDelete(CASCADE)
   likedWorkoutPrograms     LikedWorkoutProgram[]
+  /// @onDelete(CASCADE)
+  progressJournals         ProgressJournal[]
+  /// @onDelete(CASCADE)
+  userBenchmarks           UserBenchmark[]
 }
+model UserBenchmark {
+  id           String               @id @default(uuid())
+  createdAt    DateTime             @default(now())
+  createdBy    User                 @relation(fields: [createdById], references: [id])
+  createdById  String
+  name         String
+  description  String?
+  reps         Float
+  repType      WorkoutMoveRepType   @default(REPS)
+  load         Float?
+  loadUnit     LoadUnit             @default(KG)
+  distanceUnit DistanceUnit         @default(METRES)
+  scoreType    BenchmarkScoreType   @default(LOAD)
+  equipment    Equipment[]
+  move         Move                 @relation(fields: [moveId], references: [id])
+  moveId       String
+  entries      UserBenchmarkEntry[]
+}
+
+model UserBenchmarkEntry {
+  id              String        @id @default(uuid())
+  createdAt       DateTime      @default(now())
+  score           Float
+  notes           String?
+  videoUrl        String?
+  imageUrl        String?
+  userBenchmark   UserBenchmark @relation(fields: [userBenchmarkId], references: [id])
+  userBenchmarkId String
+}
+
 model Workout {
   id                String                  @id @default(uuid())
   createdAt         DateTime                @default(now())
   createdBy         User?                   @relation(fields: [createdById], references: [id])
@@ -349,19 +432,17 @@
   workout         Workout?       @relation(fields: [workoutId], references: [id])
   workoutId       String?
   /// @onDelete(CASCADE)
   workoutMoves    WorkoutMove[]
-  /// @onDelete(CASCADE)
-  // roundAdjustRules RoundAdjustRule[]
   loggedWorkout   LoggedWorkout? @relation(fields: [loggedWorkoutId], references: [id])
   loggedWorkoutId String?
 }
 model WorkoutType {
   id                  String           @id @default(uuid())
   createdAt           DateTime         @default(now())
   name                String
-  subtitle            String?
+  subtitle            String
   description         String
   placeholderImageUrl String
   scoreType           WorkoutScoreType
   workouts            Workout[]
@@ -375,8 +456,17 @@
   GROUP
   PRIVATE
 }
+enum BenchmarkScoreType {
+  // For 1,3,5 rep max etc
+  LOAD
+  // For max unbroken
+  REPS
+  // For fastest time to complete or max unbroken
+  TIME
+}
+
 enum BodyAreaFrontBack {
   BACK
   FRONT
   BOTH
```



# Migration `20200508164953-challenges-comments-replies-and-more`

This migration has been generated by ObserverMoment at 5/8/2020, 4:49:53 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "ChallengeType" AS ENUM ('PRIVATE', 'PUBLIC');

CREATE TABLE "public"."BenchmarkVideo" (
    "benchmarkId" text  NOT NULL ,
    "createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "id" text  NOT NULL ,
    "note" text   ,
    "videoUrl" text  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."BenchmarkVideoValidation" (
    "benchmarkVideoId" text  NOT NULL ,
    "createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "createdByUserId" text  NOT NULL ,
    "id" text  NOT NULL ,
    "isValid" boolean  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."BenchmarkVideoComment" (
    "benchmarkVideoValidationId" text   ,
    "comment" text  NOT NULL ,
    "createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "createdByUserId" text  NOT NULL ,
    "id" text  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."BenchmarkVideoCommentReplies" (
    "benchmarkVideoCommentId" text  NOT NULL ,
    "comment" text  NOT NULL ,
    "createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "createdByUserId" text  NOT NULL ,
    "id" text  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."PrivateChallenge" (
    "category" text   ,
    "createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "description" text   ,
    "id" text  NOT NULL ,
    "imageUrl" text   ,
    "leagueId" text  NOT NULL ,
    "name" text  NOT NULL ,
    "userId" text  NOT NULL ,
    "workoutId" text  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."PublicChallenge" (
    "category" text   ,
    "createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "description" text   ,
    "id" text  NOT NULL ,
    "imageUrl" text   ,
    "name" text  NOT NULL ,
    "userId" text   ,
    "workoutId" text  NOT NULL ,
    PRIMARY KEY ("id")
) 

ALTER TABLE "public"."Benchmark" DROP CONSTRAINT IF EXiSTS "Benchmark_workoutId_fkey",
DROP COLUMN "notes",
DROP COLUMN "workoutId",
ADD COLUMN "benchmarkVideoId" text   ,
ADD COLUMN "note" text   ,
ADD COLUMN "privateChallengeId" text   ,
ADD COLUMN "publicChallengeId" text   ;

ALTER TABLE "public"."League" ADD COLUMN "countryCode" text   ;

ALTER TABLE "public"."Move" ADD COLUMN "demoVideoUrl" text   ,
ADD COLUMN "description" text   ;

CREATE UNIQUE INDEX "BenchmarkVideoComment_benchmarkVideoValidationId" ON "public"."BenchmarkVideoComment"("benchmarkVideoValidationId")

CREATE UNIQUE INDEX "PrivateChallenge.name" ON "public"."PrivateChallenge"("name")

CREATE UNIQUE INDEX "PublicChallenge.name" ON "public"."PublicChallenge"("name")

CREATE UNIQUE INDEX "Benchmark_benchmarkVideoId" ON "public"."Benchmark"("benchmarkVideoId")

ALTER TABLE "public"."BenchmarkVideoValidation" ADD FOREIGN KEY ("createdByUserId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."BenchmarkVideoValidation" ADD FOREIGN KEY ("benchmarkVideoId")REFERENCES "public"."BenchmarkVideo"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."BenchmarkVideoComment" ADD FOREIGN KEY ("createdByUserId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."BenchmarkVideoComment" ADD FOREIGN KEY ("benchmarkVideoValidationId")REFERENCES "public"."BenchmarkVideoValidation"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."BenchmarkVideoCommentReplies" ADD FOREIGN KEY ("createdByUserId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."BenchmarkVideoCommentReplies" ADD FOREIGN KEY ("benchmarkVideoCommentId")REFERENCES "public"."BenchmarkVideoComment"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."PrivateChallenge" ADD FOREIGN KEY ("leagueId")REFERENCES "public"."League"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."PrivateChallenge" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."PrivateChallenge" ADD FOREIGN KEY ("workoutId")REFERENCES "public"."Workout"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."PublicChallenge" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."PublicChallenge" ADD FOREIGN KEY ("workoutId")REFERENCES "public"."Workout"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Benchmark" ADD FOREIGN KEY ("privateChallengeId")REFERENCES "public"."PrivateChallenge"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."Benchmark" ADD FOREIGN KEY ("publicChallengeId")REFERENCES "public"."PublicChallenge"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."Benchmark" ADD FOREIGN KEY ("benchmarkVideoId")REFERENCES "public"."BenchmarkVideo"("id") ON DELETE SET NULL  ON UPDATE CASCADE

DROP TABLE "public"."WorkoutVideo";
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200507163651-user-country-to-country-code..20200508164953-challenges-comments-replies-and-more
--- datamodel.dml
+++ datamodel.dml
@@ -4,79 +4,121 @@
 generator client {
   provider = "prisma-client-js"
 }
-// url = "***"
+// url      = env("DATABASE_URL")
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = "postgres://vksegplfohzkfb:4006286c49b2ccada42a32cc56f0405ae370152bd9e594d3f38b5d1f34cebadb@ec2-79-125-26-232.eu-west-1.compute.amazonaws.com:5432/dfj0e91erhbqs1"
 }
 model Benchmark {
-  id           String        @default(uuid()) @id
-  createdAt    DateTime      @default(now())
-  completedOn  DateTime
-  level        Level
-  score        Int
-  notes        String?
-  user         User          @relation(fields: [userId], references: [id])
-  userId       String
-  workout      Workout       @relation(fields: [workoutId], references: [id])
-  workoutId    String
-  workoutVideo WorkoutVideo?
+  id                 String            @default(uuid()) @id
+  createdAt          DateTime          @default(now())
+  completedOn        DateTime
+  level              Level
+  score              Int
+  note               String?
+  user               User              @relation(fields: [userId], references: [id])
+  userId             String
+  privateChallenge   PrivateChallenge? @relation(fields: [privateChallengeId], references: [id])
+  privateChallengeId String?
+  publicChallenge    PublicChallenge?  @relation(fields: [publicChallengeId], references: [id])
+  publicChallengeId  String?
+  benchmarkVideo     BenchmarkVideo?   @relation(fields: [benchmarkVideoId], references: [id])
+  benchmarkVideoId   String?
 }
-model League {
-  id          String  @default(uuid()) @id
-  logoUrl     String?
-  name        String  @unique
+model BenchmarkVideo {
+  id                        String                     @default(uuid()) @id
+  createdAt                 DateTime                   @default(now())
+  videoUrl                  String
+  note                      String?
+  benchmark                 Benchmark
+  benchmarkId               String
+  benchmarkVideoValidations BenchmarkVideoValidation[]
+}
+
+model BenchmarkVideoValidation {
+  id                    String                @default(uuid()) @id
+  createdAt             DateTime              @default(now())
+  createdByUser         User                  @relation(fields: [createdByUserId], references: [id])
+  createdByUserId       String
+  isValid               Boolean
+  benchmarkVideo        BenchmarkVideo        @relation(fields: [benchmarkVideoId], references: [id])
+  benchmarkVideoId      String
+  benchmarkVideoComment BenchmarkVideoComment
+}
+
+model BenchmarkVideoComment {
+  id                         String                         @default(uuid()) @id
+  createdAt                  DateTime                       @default(now())
+  createdByUser              User                           @relation(fields: [createdByUserId], references: [id])
+  createdByUserId            String
+  benchmarkVideoValidation   BenchmarkVideoValidation?      @relation(fields: [benchmarkVideoValidationId], references: [id])
+  benchmarkVideoValidationId String?
+  comment                    String
+  replies                    BenchmarkVideoCommentReplies[]
+}
+
+model BenchmarkVideoCommentReplies {
+  id                      String                @default(uuid()) @id
+  createdAt               DateTime              @default(now())
+  createdByUser           User                  @relation(fields: [createdByUserId], references: [id])
+  createdByUserId         String
+  comment                 String
+  benchmarkVideoComment   BenchmarkVideoComment @relation(fields: [benchmarkVideoCommentId], references: [id])
+  benchmarkVideoCommentId String
+}
+
+model PrivateChallenge {
+  id          String      @default(uuid()) @id
+  createdAt   DateTime    @default(now())
+  name        String      @unique
+  category    String?
   description String?
-  user        User[]  @relation(references: [id])
+  imageUrl    String?
+  league      League      @relation(fields: [leagueId], references: [id])
+  leagueId    String
+  user        User        @relation(fields: [userId], references: [id])
+  userId      String
+  workout     Workout     @relation(fields: [workoutId], references: [id])
+  workoutId   String
+  benchmarks  Benchmark[]
 }
+model PublicChallenge {
+  id          String      @default(uuid()) @id
+  createdAt   DateTime    @default(now())
+  name        String      @unique
+  category    String?
+  description String?
+  imageUrl    String?
+  User        User?       @relation(fields: [userId], references: [id])
+  userId      String?
+  workout     Workout     @relation(fields: [workoutId], references: [id])
+  workoutId   String
+  benchmarks  Benchmark[]
+}
+
+model League {
+  id                String             @default(uuid()) @id
+  logoUrl           String?
+  name              String             @unique
+  countryCode       String?
+  description       String?
+  users             User[]             @relation(references: [id])
+  privateChallenges PrivateChallenge[]
+}
+
 model Move {
   id           String        @default(uuid()) @id
   name         String        @unique
+  description  String?
+  demoVideoUrl String?
   workoutMoves WorkoutMove[]
 }
-// Height in cms / weight in kgs
-model User {
-  id           String        @default(uuid()) @id
-  firebaseUid  String        @unique
-  createdAt    DateTime      @default(now())
-  hasOnboarded Boolean       @default(false)
-  avatarUrl    String?
-  displayName  String?       @unique
-  firstname    String?
-  lastname     String?
-  bio          String?
-  birthdate    DateTime?
-  gender       Gender?
-  height       Float?
-  weight       Float?
-  gymBox       String?
-  townCity     String?
-  countryCode  String?
-  unitSystem   UnitSystem    @default(METRIC)
-  benchmarks   Benchmark[]
-  leagues      League[]      @relation(references: [id])
-  worldRecords WorldRecord[]
-}
-
-model Workout {
-  id            String         @default(uuid()) @id
-  name          String         @unique
-  category      WodCategory
-  summary       String
-  description   String?
-  workoutType   WorkoutType
-  workoutMoves  WorkoutMove[]
-  workoutVideos WorkoutVideo[]
-  worldRecord   WorldRecord[]
-  benchmarks    Benchmark[]
-}
-
 model WorkoutMove {
   id                  String  @default(uuid()) @id
   beginnerScaling     String?
   intermediateScaling String?
@@ -87,17 +129,19 @@
   workout             Workout @relation(fields: [workoutId], references: [id])
   workoutId           String
 }
-model WorkoutVideo {
-  id          String    @default(uuid()) @id
-  createdAt   DateTime  @default(now())
-  videoUrl    String
-  notes       String?
-  workout     Workout   @relation(fields: [workoutId], references: [id])
-  workoutId   String
-  benchmark   Benchmark @relation(fields: [benchmarkId], references: [id])
-  benchmarkId String
+model Workout {
+  id                String             @default(uuid()) @id
+  name              String             @unique
+  category          WodCategory
+  summary           String
+  description       String?
+  workoutType       WorkoutType
+  workoutMoves      WorkoutMove[]
+  worldRecords      WorldRecord[]
+  privateChallenges PrivateChallenge[]
+  publicChallenges  PublicChallenge[]
 }
 model WorldRecord {
   id          String     @default(uuid()) @id
@@ -112,8 +156,37 @@
   user        User?      @relation(fields: [userId], references: [id])
   userId      String?
 }
+// Height in cms / weight in kgs
+model User {
+  id                           String                         @default(uuid()) @id
+  firebaseUid                  String                         @unique
+  createdAt                    DateTime                       @default(now())
+  hasOnboarded                 Boolean                        @default(false)
+  avatarUrl                    String?
+  displayName                  String?                        @unique
+  firstname                    String?
+  lastname                     String?
+  bio                          String?
+  birthdate                    DateTime?
+  gender                       Gender?
+  height                       Float?
+  weight                       Float?
+  gymBox                       String?
+  townCity                     String?
+  countryCode                  String?
+  unitSystem                   UnitSystem                     @default(METRIC)
+  benchmarks                   Benchmark[]
+  leagues                      League[]
+  worldRecords                 WorldRecord[]
+  privateChallenges            PrivateChallenge[]
+  publicChallenges             PublicChallenge[]
+  benchmarkVideoValidations    BenchmarkVideoValidation[]
+  benchmarkVideoComments       BenchmarkVideoComment[]
+  BenchmarkVideoCommentReplies BenchmarkVideoCommentReplies[]
+}
+
 // Enums
 enum Gender {
   MALE
   FEMALE
@@ -149,5 +222,11 @@
 enum WorkoutType {
   AMRAP
   FORTIME
   FORLOAD
+}
+
+// Used on table WorkoutToChallenge to allow polymorphic relation
+enum ChallengeType {
+  PRIVATE
+  PUBLIC
 }
```



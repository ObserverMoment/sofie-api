# Migration `20201118095839-logged-workouts-move-to-program-enrolments`

This migration has been generated by ObserverMoment at 11/18/2020, 9:58:39 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
DROP INDEX "WorkoutProgramWorkout_loggedWorkoutId_unique"

ALTER TABLE "WorkoutProgramWorkout" DROP CONSTRAINT "WorkoutProgramWorkout_loggedWorkoutId_fkey"

ALTER TABLE "LoggedWorkout" ADD COLUMN     "workoutProgramEnrolmentId" TEXT,
ADD COLUMN     "workoutProgramWorkoutId" TEXT

ALTER TABLE "WorkoutProgramWorkout" DROP COLUMN "loggedWorkoutId"

ALTER TABLE "LoggedWorkout" ADD FOREIGN KEY("workoutProgramEnrolmentId")REFERENCES "WorkoutProgramEnrolment"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "LoggedWorkout" ADD FOREIGN KEY("workoutProgramWorkoutId")REFERENCES "WorkoutProgramWorkout"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201117084943-workout-program-workout-logged-workout-body-areas..20201118095839-logged-workouts-move-to-program-enrolments
--- datamodel.dml
+++ datamodel.dml
@@ -6,9 +6,9 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 model BodyArea {
   id                 String              @id @default(uuid())
@@ -76,32 +76,35 @@
 }
 // Data from a completed workout. Also inlcudes relation to the 'original' workout
 model LoggedWorkout {
-  id                    String                 @id @default(uuid())
-  name                  String
-  summary               String?
-  description           String?
-  createdAt             DateTime               @default(now())
-  completedOn           DateTime
-  completedBy           User                   @relation(fields: [completedById], references: [id])
-  completedById         String
-  notes                 String?
-  videoUrl              String?
-  videoThumbUrl         String?
-  imageUrl              String?
-  duration              Int?
-  workoutType           WorkoutType            @relation(fields: [workoutTypeId], references: [id])
-  workoutTypeId         String
+  id                        String                   @id @default(uuid())
+  name                      String
+  summary                   String?
+  description               String?
+  createdAt                 DateTime                 @default(now())
+  completedOn               DateTime
+  completedBy               User                     @relation(fields: [completedById], references: [id])
+  completedById             String
+  notes                     String?
+  videoUrl                  String?
+  videoThumbUrl             String?
+  imageUrl                  String?
+  duration                  Int?
+  workoutType               WorkoutType              @relation(fields: [workoutTypeId], references: [id])
+  workoutTypeId             String
   /// @onDelete(CASCADE)
-  workoutSections       WorkoutSection[]
-  originalWorkout       Workout?               @relation(fields: [originalWorkoutId], references: [id])
-  originalWorkoutId     String?
-  scheduledWorkout      ScheduledWorkout?
-  scheduledWorkoutId    String?
-  workoutProgramWorkout WorkoutProgramWorkout?
-  gymProfile            GymProfile?            @relation(fields: [gymProfileId], references: [id])
-  gymProfileId          String?
+  workoutSections           WorkoutSection[]
+  originalWorkout           Workout?                 @relation(fields: [originalWorkoutId], references: [id])
+  originalWorkoutId         String?
+  scheduledWorkout          ScheduledWorkout?
+  scheduledWorkoutId        String?
+  gymProfile                GymProfile?              @relation(fields: [gymProfileId], references: [id])
+  gymProfileId              String?
+  WorkoutProgramEnrolment   WorkoutProgramEnrolment? @relation(fields: [workoutProgramEnrolmentId], references: [id])
+  workoutProgramEnrolmentId String?
+  workoutProgramWorkout     WorkoutProgramWorkout?   @relation(fields: [workoutProgramWorkoutId], references: [id])
+  workoutProgramWorkoutId   String?
 }
 model Move {
   id                      String               @id @default(uuid())
@@ -269,16 +272,19 @@
   programReviews  WorkoutProgramReview[]
   likes           LikedWorkoutProgram[]
 }
+// A single user enrolled in a plan a single time
+// A single user can also enrol multiple times
 model WorkoutProgramEnrolment {
-  id               String         @id @default(uuid())
-  createdAt        DateTime       @default(now())
-  startDate        DateTime?      @default(now())
-  workoutProgram   WorkoutProgram @relation(fields: [workoutProgramId], references: [id])
+  id               String          @id @default(uuid())
+  createdAt        DateTime        @default(now())
+  startDate        DateTime?       @default(now())
+  workoutProgram   WorkoutProgram  @relation(fields: [workoutProgramId], references: [id])
   workoutProgramId String
-  user             User           @relation(fields: [userId], references: [id])
+  user             User            @relation(fields: [userId], references: [id])
   userId           String
+  loggedWorkouts   LoggedWorkout[]
 }
 model WorkoutProgramReview {
   id               String         @id @default(uuid())
@@ -291,20 +297,19 @@
   userId           String
 }
 model WorkoutProgramWorkout {
-  id               String         @id @default(uuid())
-  createdAt        DateTime       @default(now())
+  id               String          @id @default(uuid())
+  createdAt        DateTime        @default(now())
   // Day on which the workout is planned. i.e. day 8 == week 2 day 1.
   // The decimal can be used to differentiate between having multiple workouts on each day.
   dayNumber        Float
   notes            String?
-  workoutProgram   WorkoutProgram @relation(fields: [workoutProgramId], references: [id])
+  workoutProgram   WorkoutProgram  @relation(fields: [workoutProgramId], references: [id])
   workoutProgramId String
-  workout          Workout        @relation(fields: [workoutId], references: [id])
+  workout          Workout         @relation(fields: [workoutId], references: [id])
   workoutId        String
-  loggedWorkout    LoggedWorkout? @relation(fields: [loggedWorkoutId], references: [id])
-  loggedWorkoutId  String?
+  loggedWorkouts   LoggedWorkout[]
 }
 // Need to implement some more solid polymorphism here if we want to allow a workoutSection
 // to be on a workout or a loggedWorkout
```



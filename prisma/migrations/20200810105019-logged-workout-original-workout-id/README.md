# Migration `20200810105019-logged-workout-original-workout-id`

This migration has been generated by ObserverMoment at 8/10/2020, 11:50:19 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."_ChallengeToWorkout" DROP CONSTRAINT "_ChallengeToWorkout_A_fkey"

ALTER TABLE "public"."_ChallengeToWorkout" DROP CONSTRAINT "_ChallengeToWorkout_B_fkey"

ALTER TABLE "public"."LoggedWorkout" DROP CONSTRAINT "LoggedWorkout_workoutId_fkey"

ALTER TABLE "public"."ScheduledWorkout" DROP CONSTRAINT "ScheduledWorkout_challengeId_fkey"

ALTER TABLE "public"."WorkoutSection" DROP CONSTRAINT "WorkoutSection_loggedWorkoutId_fkey"

ALTER TABLE "public"."LoggedWorkout" DROP COLUMN "workoutId",
ADD COLUMN "workoutDataId" text  NOT NULL ,
ADD COLUMN "originalWorkoutId" text   ;

ALTER TABLE "public"."ScheduledWorkout" DROP COLUMN "challengeId";

ALTER TABLE "public"."WorkoutSection" DROP COLUMN "loggedWorkoutId";

ALTER TABLE "public"."LoggedWorkout" ADD FOREIGN KEY ("workoutDataId")REFERENCES "public"."Workout"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."LoggedWorkout" ADD FOREIGN KEY ("originalWorkoutId")REFERENCES "public"."Workout"("id") ON DELETE SET NULL ON UPDATE CASCADE

DROP TABLE "public"."_ChallengeToWorkout";
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200810083040-logged-workout-video-image..20200810105019-logged-workout-original-workout-id
--- datamodel.dml
+++ datamodel.dml
@@ -6,9 +6,9 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 model ScoreSubmission {
   id                     String                @default(uuid()) @id
@@ -67,30 +67,28 @@
   scoreSubmissionVideoCommentId String
 }
 model Challenge {
-  id               String             @default(uuid()) @id
-  createdAt        DateTime           @default(now())
-  scope            AccessScopeType    @default(PRIVATE)
-  name             String             @unique
+  id               String            @default(uuid()) @id
+  createdAt        DateTime          @default(now())
+  scope            AccessScopeType   @default(PRIVATE)
+  name             String            @unique
   category         String?
   description      String?
   imageUrl         String?
-  repsPerPoint     Int                @default(5)
-  secsPerPoint     Int                @default(5)
-  mtrsPerPoint     Int                @default(5)
-  calsPerPoint     Int                @default(5)
-  scoreByPosition  Boolean            @default(false)
+  repsPerPoint     Int               @default(5)
+  secsPerPoint     Int               @default(5)
+  mtrsPerPoint     Int               @default(5)
+  calsPerPoint     Int               @default(5)
+  scoreByPosition  Boolean           @default(false)
   // If true, score multiplies across workouts, else they sum
-  multiplyScores   Boolean            @default(false)
-  group            Group              @relation(fields: [groupId], references: [id])
+  multiplyScores   Boolean           @default(false)
+  group            Group             @relation(fields: [groupId], references: [id])
   groupId          String
-  createdBy        User               @relation(fields: [createdById], references: [id])
+  createdBy        User              @relation(fields: [createdById], references: [id])
   createdById      String
-  workouts         Workout[]          @relation(references: [id])
   scoreSubmissions ScoreSubmission[]
-  watchers         User[]             @relation("watchersToChallenges", references: [id])
-  scheduledWorkout ScheduledWorkout[]
+  watchers         User[]            @relation("watchersToChallenges", references: [id])
 }
 model Group {
   id          String          @default(uuid()) @id
@@ -158,12 +156,12 @@
   difficultyLevel   DifficultyLevel    @default(ONE)
   scope             AccessScopeType    @default(PRIVATE)
   workoutType       WorkoutType        @relation(fields: [workoutTypeId], references: [id])
   workoutTypeId     String
-  challenges        Challenge[]        @relation(references: [id])
+  workoutSections   WorkoutSection[]
   scheduledWorkouts ScheduledWorkout[]
-  workoutSections   WorkoutSection[]
-  LoggedWorkout     LoggedWorkout[]
+  loggedWorkouts    LoggedWorkout[]
+  LoggedWorkout     LoggedWorkout[]    @relation("workoutData")
 }
 model WorkoutSection {
   id               String            @default(uuid()) @id
@@ -175,10 +173,8 @@
   workout          Workout           @relation(fields: [workoutId], references: [id])
   workoutId        String
   workoutMoves     WorkoutMove[]
   roundAdjustRules RoundAdjustRule[]
-  LoggedWorkout    LoggedWorkout?    @relation(fields: [loggedWorkoutId], references: [id])
-  loggedWorkoutId  String?
 }
 // Every {roundFrequency} rounds {operator} reps by {amount}
 // Eg. Every 3 rounds INCREASE reps by 10 (for all workout moves within the section)
@@ -232,13 +228,11 @@
   workout         Workout        @relation(fields: [workoutId], references: [id])
   workoutId       String
   loggedWorkout   LoggedWorkout? @relation(fields: [loggedWorkoutId], references: [id])
   loggedWorkoutId String?
-  challenge       Challenge?     @relation(fields: [challengeId], references: [id])
-  challengeId     String?
 }
-// Data from a completed workout.
+// Data from a completed workout. Also inlcudes relation to the 'original' workout
 model LoggedWorkout {
   id                 String            @default(uuid()) @id
   createdAt          DateTime          @default(now())
   completedOn        DateTime          @default(now())
@@ -246,11 +240,12 @@
   completedById      String
   notes              String?
   videoUrl           String?
   imageUrl           String?
-  workoutSections    WorkoutSection[]
-  workout            Workout           @relation(fields: [workoutId], references: [id])
-  workoutId          String
+  workoutData        Workout           @relation("workoutData", fields: [workoutDataId], references: [id])
+  workoutDataId      String
+  originalWorkout    Workout?          @relation(fields: [originalWorkoutId], references: [id])
+  originalWorkoutId  String?
   scheduledWorkout   ScheduledWorkout?
   scheduledWorkoutId String?
   scoreSubmissions   ScoreSubmission[]
 }
```


